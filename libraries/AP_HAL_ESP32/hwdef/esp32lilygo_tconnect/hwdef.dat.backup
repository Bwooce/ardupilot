# ArduPilot Hardware Definition for ESP32-Buzz Board
# Based on ESP32 Classic with MPU9250 IMU and BMP280 barometer via SPI
# Complete configuration matching original esp32buzz.h static header

MCU ESP32

# Board identification  
define HAL_ESP32_BOARD_NAME "esp32-buzz"

# Sensor probe helper macros for easier configuration
define PROBE_IMU_I2C(driver, bus, addr, args ...) ADD_BACKEND(AP_InertialSensor_ ## driver::probe(*this,GET_I2C_DEVICE(bus, addr),##args))
define PROBE_IMU_SPI(driver, devname, args ...) ADD_BACKEND(AP_InertialSensor_ ## driver::probe(*this,hal.spi->get_device(devname),##args))
define PROBE_IMU_SPI2(driver, devname1, devname2, args ...) ADD_BACKEND(AP_InertialSensor_ ## driver::probe(*this,hal.spi->get_device(devname1),hal.spi->get_device(devname2),##args))
define PROBE_BARO_I2C(driver, bus, addr, args ...) ADD_BACKEND(AP_Baro_ ## driver::probe(*this,std::move(GET_I2C_DEVICE(bus, addr)),##args))
define PROBE_BARO_SPI(driver, devname, args ...) ADD_BACKEND(AP_Baro_ ## driver::probe(*this,std::move(hal.spi->get_device(devname)),##args))
define PROBE_MAG_I2C(driver, bus, addr, args ...) ADD_BACKEND(DRIVER_ ##driver, AP_Compass_ ## driver::probe(GET_I2C_DEVICE(bus, addr),##args))
define PROBE_MAG_SPI(driver, devname, args ...) ADD_BACKEND(DRIVER_ ##driver, AP_Compass_ ## driver::probe(hal.spi->get_device(devname),##args))
define PROBE_MAG_IMU(driver, imudev, imu_instance, args ...) ADD_BACKEND(DRIVER_ ##driver, AP_Compass_ ## driver::probe_ ## imudev(imu_instance,##args))
define PROBE_MAG_IMU_I2C(driver, imudev, bus, addr, args ...) ADD_BACKEND(DRIVER_ ##driver, AP_Compass_ ## driver::probe_ ## imudev(GET_I2C_DEVICE(bus,addr),##args))

# IMU Configuration - MPU9250 via SPI (default)
define HAL_INS_DEFAULT HAL_INS_MPU9250_SPI
define HAL_INS_MPU9250_NAME "mpu9250"
define HAL_INS_PROBE_LIST PROBE_IMU_SPI(Invensense, HAL_INS_MPU9250_NAME, ROTATION_NONE)

# Alternative IMU configurations (uncomment to use):
# For ICM20XXX via I2C instead:
# define HAL_INS_DEFAULT HAL_INS_ICM20XXX_I2C
# define HAL_INS_ICM20XXX_I2C_BUS 0
# define HAL_INS_ICM20XXX_I2C_ADDR 0x68
# define HAL_INS_PROBE_LIST PROBE_IMU_I2C(Invensensev2, 0, 0x68, ROTATION_YAW_270)

# Alternative rotation if board mounted differently:
# define HAL_INS_PROBE_LIST PROBE_IMU_SPI(Invensense, HAL_INS_MPU9250_NAME, ROTATION_ROLL_180)

# Barometer - BMP280 via SPI (default)
define HAL_BARO_PROBE_LIST PROBE_BARO_SPI(BMP280, "bmp280")
define HAL_BARO_ALLOW_INIT_NO_BARO 1

# Alternative barometer configurations (uncomment to use):
# For I2C barometer instead:
# define HAL_BARO_PROBE_LIST PROBE_BARO_I2C(BMP280, 0, 0x77)

# Compass configuration
define HAL_PROBE_EXTERNAL_I2C_COMPASSES 1

# Alternative compass configurations (uncomment to use):
# For specific compass types:
# define HAL_COMPASS_ICM20948_I2C_ADDR 0x68
# define HAL_COMPASS_AK09916_I2C_BUS 0
# define HAL_COMPASS_AK09916_I2C_ADDR 0x0C
# define HAL_COMPASS_MAX_SENSORS 3
# define HAL_MAG_PROBE_LIST ADD_BACKEND(DRIVER_ICM20948, AP_Compass_AK09916::probe_ICM20948_I2C(0, ROTATION_NONE))

# Airspeed sensor disabled
define AP_AIRSPEED_MS4525_ENABLED 0
define AP_AIRSPEED_ENABLED 0
define AP_AIRSPEED_ANALOG_ENABLED 0
define AP_AIRSPEED_BACKEND_DEFAULT_ENABLED 0

# ADC Configuration
define HAL_USE_ADC 1

# WiFi Configuration  
# 1 = TCP mode, 2 = UDP mode
# For UDP: client connects as UDPCL in MissionPlanner to 192.168.4.1 port 14550
define HAL_ESP32_WIFI 1
define WIFI_SSID "ardupilot123"
define WIFI_PWD "ardupilot123"

# WiFi Usage Tips:
# - To disable MAVLink over USB serial and use WiFi only: Set SERIAL0_PROTOCOL = 0 and reboot
# - Recommended parameters for WiFi logging:
#   LOG_BACKEND_TYPE 1   (log to flash/SD)
#   LOG_DISARMED 1       (log when disarmed)
#   SERIAL0_PROTOCOL 0   (disable USB MAVLink)

# Storage Configuration
# SD Card support: Choose MMC (faster, fixed pins) or SPI (flexible pins)
define HAL_ESP32_SDCARD 1
define HAL_ESP32_SDMMC 1    # MMC mode - uses specific pins but is faster
define AP_FILESYSTEM_ESP32_ENABLED 1
define HAL_BOARD_LOG_DIRECTORY "/SDCARD/APM/LOGS"
define HAL_BOARD_STORAGE_DIRECTORY "/SDCARD/APM/STORAGE" 
define HAL_BOARD_TERRAIN_DIRECTORY "/SDCARD/APM/TERRAIN"

# Alternative: SPI mode for SD card (more flexible pinout, uncomment to use):
# define HAL_ESP32_SDSPI {.host=VSPI_HOST, .dma_ch=2, .mosi=GPIO_NUM_2, .miso=GPIO_NUM_15, .sclk=GPIO_NUM_14, .cs=GPIO_NUM_21}

# Logging Configuration
# Default value for LOG_BACKEND_TYPE parameter:
# 1 = log to flash/SD card (most common)
# 2 = log over MAVLink to companion computer
define HAL_LOGGING_BACKENDS_DEFAULT 1
define LOGGER_MAVLINK_SUPPORT 1

# Pin Configuration (from esp32buzz.h)
# ESP32 Classic pin assignments matching static header exactly

# SPI1 Bus - VSPI for IMU (MPU9250) and Barometer (BMP280)
SPI1_SCK_PIN 18
SPI1_MISO_PIN 19  
SPI1_MOSI_PIN 23
MPU9250_CS_PIN 5
BMP280_CS_PIN 26

# I2C0 Bus - for external compass and sensors  
I2C0_SDA_PIN 13
I2C0_SCL_PIN 12

# UART Configuration
# UART0: TX=1, RX=3 (USB programming)
SERIAL0_TX_PIN 1
SERIAL0_RX_PIN 3
# UART1: TX=17, RX=16 (additional serial)
SERIAL1_TX_PIN 17
SERIAL1_RX_PIN 16

# RCOUT pins for servo/motor control (6 channels)
RCOUT1_PIN 25
RCOUT2_PIN 27
RCOUT3_PIN 33
RCOUT4_PIN 32
RCOUT5_PIN 22
RCOUT6_PIN 21

# RCIN pin for receiver input
RCIN_PIN 4

# RMT configuration for receiver
define HAL_ESP32_RMT_RX_PIN_NUMBER 4

# ADC Configuration - ESP32 has ADC available on many pins
# NOTE: ADC2 can't co-exist with WiFi, so we use ADC1 pins only
# Two different pin numbering schemes are available:

# OPTION1: Sequential pin numbering (1-4)
# Pin assignments: {ADC1_GPIO35_CHANNEL, 11, 1}, {ADC1_GPIO34_CHANNEL, 11, 2}, {ADC1_GPIO39_CHANNEL, 11, 3}, {ADC1_GPIO36_CHANNEL, 11, 4}
# Use this if you want ArduPilot parameter names like ADC_PIN, ADC_PIN2, etc.

# OPTION2: GPIO pin numbering (35,34,39,36) - CURRENTLY ACTIVE
# Pin assignments: {ADC1_GPIO35_CHANNEL, 11, 35}, {ADC1_GPIO34_CHANNEL, 11, 34}, {ADC1_GPIO39_CHANNEL, 11, 39}, {ADC1_GPIO36_CHANNEL, 11, 36}  
# Use this if you want ArduPilot parameter names to match GPIO numbers
ADC1_PIN 35
ADC2_PIN 34  
ADC3_PIN 39
ADC4_PIN 36

# To disable ADC completely (uncomment if not using analog sensors):
# define HAL_DISABLE_ADC_DRIVER 1

# Debugging options - uncomment ONE at a time to avoid stack overflow
# define STORAGEDEBUG 1
# define SCHEDDEBUG 1  
# define FSDEBUG 1
# define BUSDEBUG 1
# define WIFIDEBUG 1
# define INS_TIMING_DEBUG 1

# Alternative IMU rotation if needed:
# define HAL_INS_PROBE_LIST PROBE_IMU_SPI(Invensense, HAL_INS_MPU9250_NAME, ROTATION_ROLL_180)