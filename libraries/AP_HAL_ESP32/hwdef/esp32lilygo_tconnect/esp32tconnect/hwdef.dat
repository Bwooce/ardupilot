# ESP32-S3 Board Definition - Fixed for ArduPilot
# Based on ESP32-S3 with CAN transceivers and interfaces

# MCU Configuration - Correct ESP32-S3 syntax
MCU ESP32S3 ESP32S3
define CONFIG_HAL_BOARD HAL_BOARD_ESP32
define CONFIG_HAL_BOARD_SUBTYPE HAL_BOARD_SUBTYPE_ESP32_S3

# Board identification - ESP32-S3
APJ_BOARD_ID 1050
define BOARD_TYPE_DEFAULT 1050

# ESP32-S3 Memory and Flash
define HAL_STORAGE_SIZE 32768
define HAL_FLASH_SECTOR_SIZE 4096

# Flash Configuration - ESP32-S3
FLASH_SIZE_KB 16384
define HAL_STORAGE_SIZE 32768
define HAL_FLASH_SECTOR_SIZE 4096

# Basic Features
define HAL_WITH_UAVCAN 1
define HAL_MAX_CAN_PROTOCOL_DRIVERS 2
define HAL_ENABLE_LIDAR_DRIVERS 1
define HAL_ENABLE_DRONECAN 1

# CAN Bus Configuration - 2 CAN buses (T-Connect limitation)
CAN_ORDER 1 2
define HAL_NUM_CAN_IFACES 2

# CAN1 - Primary CAN bus
PA11 CAN1_RX CAN1
PA12 CAN1_TX CAN1
define CAN1_PROTOCOL DRONECAN

# CAN2 - Secondary CAN bus  
PB5 CAN2_RX CAN2
PB6 CAN2_TX CAN2
define CAN2_PROTOCOL DRONECAN

# UART Configuration
SERIAL_ORDER OTG1 UART1 UART2 UART3 UART4 UART5

# USB OTG
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1
define HAL_USE_OTG 1

# UART1 - GPS Primary
PA9 UART1_TX UART1
PA10 UART1_RX UART1
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_GPS

# UART2 - Telemetry
PA2 UART2_TX UART2
PA3 UART2_RX UART2
define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_MAVLink

# UART3 - GPS Secondary/Compass
PB10 UART3_TX UART3
PB11 UART3_RX UART3
define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_GPS

# UART4 - User configurable
PC10 UART4_TX UART4
PC11 UART4_RX UART4
define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_None

# UART5 - Debug/User
PC12 UART5_TX UART5
PD2 UART5_RX UART5
define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_None

# I2C Configuration
I2C_ORDER I2C1 I2C2

# I2C1 - Primary I2C (IMU, Compass, etc.)
PB6 I2C1_SCL I2C1
PB7 I2C1_SDA I2C1
define HAL_I2C_INTERNAL_MASK 1

# I2C2 - External I2C
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2
define HAL_I2C_EXTERNAL_MASK 2

# SPI Configuration
SPI_ORDER SPI1 SPI2

# SPI1 - IMU
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1
PA4 MPU6000_CS CS
define HAL_IMU_TEMP_DEFAULT 55

# SPI2 - External devices
PB13 SPI2_SCK SPI2
PB14 SPI2_MISO SPI2
PB15 SPI2_MOSI SPI2
PB12 SPI2_CS1 CS
PC7 SPI2_CS2 CS

# PWM Output Configuration for Ackermann steering rover
# Single front steering servo
PA0 SERVO1_PWM PWM(1)  # Front Ackermann Steering Servo

# Additional PWM outputs for other functions
PA1 SERVO2_PWM PWM(2)  # Auxiliary output (lights, etc.)
PA15 SERVO3_PWM PWM(3) # Auxiliary output (gripper, etc.)
PB3 SERVO4_PWM PWM(4)  # Auxiliary output (camera gimbal, etc.)
PC6 SERVO5_PWM PWM(5)  # Auxiliary output
PC7 SERVO6_PWM PWM(6)  # Auxiliary output
PC8 SERVO7_PWM PWM(7)  # Auxiliary output
PC9 SERVO8_PWM PWM(8)  # Auxiliary output

# GPIO Configuration
# Status LEDs
PC13 LED_BOOTLOADER OUTPUT HIGH
PC14 LED_ACTIVITY OUTPUT LOW
PC15 LED_ERROR OUTPUT LOW

# Safety switch
PB0 SAFETY_SWITCH INPUT PULLUP
PB1 SAFETY_LED OUTPUT LOW

# Buzzer
PB8 BUZZER OUTPUT LOW

# Power monitoring
PC0 BATT_VOLTAGE_SENS ADC1
PC1 BATT_CURRENT_SENS ADC1
PC2 BATT2_VOLTAGE_SENS ADC1
PC3 BATT2_CURRENT_SENS ADC1

# IMU Configuration
IMU BMI270 SPI:mpu6000 ROTATION_ROLL_180_YAW_90
define HAL_DEFAULT_INS_FAST_SAMPLE 1

# Compass Configuration
COMPASS AK09915 I2C:0:0x0C false ROTATION_ROLL_180_YAW_90
define HAL_COMPASS_DEFAULT HAL_COMPASS_AK09915

# Barometer Configuration
BARO DPS310 I2C:0:0x77
define HAL_BARO_DEFAULT HAL_BARO_DPS310

# Default Parameters for Rover with DroneCAN motors
define HAL_DEFAULT_FRAME_CLASS 2  # Rover frame class
define HAL_DEFAULT_FRAME_TYPE 2   # Ackermann steering rover

# Memory Configuration - ESP32-S3 Specific
define HAL_MEM_CLASS HAL_MEM_CLASS_300
define HAL_MINIMIZE_FEATURES 0
define HAL_MINIMIZE_FLASH_SIZE 0
define HAL_ESP32_BOARD_SUBTYPE HAL_BOARD_SUBTYPE_ESP32_S3

# Networking (if WiFi module present)
define HAL_ENABLE_NETWORKING 1
define HAL_NETWORKING_BACKEND_CHIBIOS 1

# Storage
define HAL_OS_FATFS_IO 1
define HAL_BOARD_LOG_DIRECTORY "/APM/LOGS"
define HAL_BOARD_TERRAIN_DIRECTORY "/APM/TERRAIN"

# Additional Features
define HAL_RCINPUT_WITH_AP_RADIO 1
define HAL_MOUNT_ENABLED 1
define HAL_RALLY_ENABLED 1
define HAL_BEACON_ENABLED 1
define HAL_PROXIMITY_ENABLED 1
define HAL_ADSB_ENABLED 1

# Rover-specific features with DroneCAN motor control
define HAL_TORQEEDO_ENABLED 1
define HAL_GENERATOR_ENABLED 1
define HAL_EFI_ENABLED 1
define HAL_WHEEL_ENCODER_ENABLED 1
define HAL_DRONECAN_ESC_ENABLED 1

# CAN bootloader support
define HAL_ENABLE_CANBOOTLOADER 1
define HAL_CANBOOTLOADER_TIMEOUT 5000

# Bootloader configuration
define HAL_BOOTLOADER_TIMEOUT 5000
define HAL_USE_EMPTY_STORAGE 1

# Flash sectors for bootloader
FLASH_RESERVE_START_KB 64

# Environment sensor
define HAL_BARO_ALLOW_INIT_NO_BARO 1

# RSSI input
PC4 RSSI_ADC_PIN ADC1

# Optional features that can be enabled
define HAL_SPRAYER_ENABLED 1
define HAL_GRIPPER_ENABLED 1
define HAL_LANDING_GEAR_ENABLED 1
define HAL_BUTTON_ENABLED 1

# Debug
define HAL_DEBUG_BUILD 0
define HAL_ENABLE_THREAD_STATISTICS 1