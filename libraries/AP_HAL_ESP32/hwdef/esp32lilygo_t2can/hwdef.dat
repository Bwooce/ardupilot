# ArduPilot Hardware Definition for the LilyGO T-2CAN
# ESP32-S3 based dual CAN interface board for DroneCAN networks
# Features: 8MB OPI PSRAM, dual CAN interfaces (TWAI + MCP2515), minimal sensors for CAN hub operation
#

MCU ESP32S3

# Board identification
define HAL_ESP32_BOARD_NAME "esp32lilygo_t2can"
define HAL_ESP32_BOARD_SUBTYPE HAL_BOARD_SUBTYPE_ESP32_S3
define HAL_USE_OTG 1

# Sensor probe helper macros for easier configuration
define PROBE_IMU_I2C(driver, bus, addr, args ...) ADD_BACKEND(AP_InertialSensor_ ## driver::probe(*this,GET_I2C_DEVICE(bus, addr),##args))
define PROBE_IMU_SPI(driver, devname, args ...) ADD_BACKEND(AP_InertialSensor_ ## driver::probe(*this,hal.spi->get_device(devname),##args))
define PROBE_BARO_I2C(driver, bus, addr, args ...) ADD_BACKEND(AP_Baro_ ## driver::probe(*this,std::move(GET_I2C_DEVICE(bus, addr)),##args))
define PROBE_MAG_I2C(driver, bus, addr, args ...) ADD_BACKEND(DRIVER_ ##driver, AP_Compass_ ## driver::probe(GET_I2C_DEVICE(bus, addr),##args))


# PSRAM Configuration - T-2CAN has OPI PSRAM
PSRAM_SIZE 8MB
PSRAM_MODE OPI
PSRAM_MALLOC_THRESHOLD 16384
PSRAM_RESERVE_INTERNAL 16384

# DroneCAN configuration - dual CAN interfaces  
define HAL_NUM_CAN_IFACES 2
define HAL_ENABLE_DRONECAN_DRIVERS 1
define HAL_WITH_UAVCAN 1
define HAL_MAX_CAN_PROTOCOL_DRIVERS 2
define HAL_ENABLE_DRONECAN 1
define CAN1_PROTOCOL DRONECAN
define CAN2_PROTOCOL DRONECAN

# CAN Interface 1: Native ESP32-S3 TWAI (built-in CAN controller)
# VERIFIED WORKING PINS - these pins have been tested and confirmed working for CAN communication
CAN_TX_1=7
CAN_RX_1=6

# CAN Interface 2: MCP2515 SPI-based CAN controller
define MCP2515_CS_PIN 10
define MCP2515_SCLK_PIN 12  
define MCP2515_MOSI_PIN 11
define MCP2515_MISO_PIN 13
define MCP2515_RST_PIN 9

# Note: T-2CAN has dual CAN capability implemented via:
# - CAN1: Native ESP32-S3 TWAI interface (pins 6/7)
# - CAN2: MCP2515 SPI-based CAN controller (pins 9-13)

# Rover-specific sensor configuration - minimal requirements
# Rover can operate with compass-free navigation for basic operation
define HAL_COMPASS_ENABLED 0
define ALLOW_ARM_NO_COMPASS 1
define HAL_BARO_ALLOW_INIT_NO_BARO 1

# IMU Configuration - Enable minimal IMU for AHRS backend
# ArduPilot rover requires AHRS backend for startup
define AP_INERTIALSENSOR_ENABLED 1
define HAL_INS_DEFAULT HAL_INS_NONE

# Enable DCM AHRS backend (minimal attitude estimation)
define AP_AHRS_DCM_ENABLED 1

# Vehicle frame defaults for rover
define HAL_DEFAULT_FRAME_CLASS 2  # Rover
define HAL_DEFAULT_FRAME_TYPE 0   # Undefined/Generic rover

# Serial protocol defaults  
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_GPS

# Storage configuration - Use PSRAM for in-memory logging
define HAL_LOGGING_DATAFLASH_ENABLED 0
define HAL_LOGGING_FILESYSTEM_ENABLED 0
define HAL_LOGGING_MAVLINK_ENABLED 1
define HAL_LOGGING_BACKENDS_DEFAULT 2

# Storage directories
define HAL_BOARD_LOG_DIRECTORY "/APM/LOGS"
define HAL_BOARD_TERRAIN_DIRECTORY "/APM/TERRAIN"

# Feature configuration for DroneCAN hub
define HAL_MINIMIZE_FEATURES 0
define HAL_MINIMIZE_FLASH_SIZE 0
define HAL_OS_FATFS_IO 1

# Buzzer/LED Configuration 
# Note: Add your LED/buzzer pins here based on T-2CAN hardware

# PWM Output Configuration - Minimal for CAN hub operation
# Add PWM pins if needed for actuator control

# --- UART Configuration ---
UART_ORDER SERIAL0 SERIAL1 SERIAL2

# Serial 0 (USB-Serial/JTAG): Console and MAVLink
# ESP32-S3 USB-Serial/JTAG interface - hardware pins, cannot be changed
SERIAL0_TX_PIN 43
SERIAL0_RX_PIN 44
SERIAL0_BAUD 115200

# Serial 1: Telemetry/External connections
SERIAL1_TX_PIN 1
SERIAL1_RX_PIN 2
SERIAL1_BAUD 115200

# Serial 2: Additional UART for external devices
SERIAL2_TX_PIN 17
SERIAL2_RX_PIN 18
SERIAL2_BAUD 115200

# I2C bus configuration - for external sensors
I2C_ORDER I2C0
I2C0_SDA_PIN 41
I2C0_SCL_PIN 42
I2C0_SPEED 400000
I2C0_INTERNAL 1

# Enable external sensor probing via I2C
define HAL_PROBE_EXTERNAL_I2C_COMPASSES 1

# Alternative: Enable specific external sensors via I2C (uncomment to use):
# For BMP280 barometer via I2C:
# define HAL_BARO_PROBE_LIST PROBE_BARO_I2C(BMP280, 0, 0x77)
# For HMC5843/HMC5883 compass via I2C:
# define HAL_MAG_PROBE_LIST PROBE_MAG_I2C(HMC5843, 0, 0x1e)
# For QMC5883L compass via I2C:
# define HAL_MAG_PROBE_LIST PROBE_MAG_I2C(QMC5883L, 0, 0x0d)

# SPI Configuration for MCP2515 CAN controller
SPI_ORDER SPI2
SPI2_SCK_PIN 12
SPI2_MISO_PIN 13  
SPI2_MOSI_PIN 11

# External sensor probe configuration (for DroneCAN hub operation)
define HAL_PROBE_EXTERNAL_I2C_COMPASSES 1

# ADC Configuration - T-2CAN has limited ADC pins available
# ADC2 cannot coexist with WiFi, so use ADC1 pins if needed
# define HAL_USE_ADC 1
# ADC1_PIN 4  # GPIO4 - ADC1_CH3 (if available and not conflicting)

# Alternative: Disable ADC completely (default for DroneCAN hub)
define HAL_DISABLE_ADC_DRIVER 1
define HAL_USE_ADC 0

# RMT configuration for receiver input (if needed)
define HAL_ESP32_RMT_RX_PIN_NUMBER GPIO_NUM_14

# Debugging options - Enable minimal debug to avoid compilation issues
define AP_SIM_ENABLED 0
define HAL_WITH_DSP 0

# Enable ESP32 specific debug that doesn't break build
define HAL_GPIO_LED_ON 1

# Add custom debug printing for startup sequence
define STARTUP_DEBUG 1

# Enable console output for debugging
define HAL_CONSOLE_ENABLED 1

# CAN debug level (0=none, 1=errors, 2=warnings, 3=info, 4=verbose)
define CAN_LOGLEVEL 3

# LCD1602 I2C Display Support
define HAL_DISPLAY_ENABLED 1

# RemoteID Support - Enable for ground vehicle/obstacle beacon use
define AP_OPENDRONEID_ENABLED 1
define AP_DRONECAN_SEND_GPS 1
# For ground/stationary use, configure as:
# - RID_TYPE = 2 (MAV_ODID_CATEGORY_EU for ground obstacle)
# - RID_UA_TYPE = 15 (MAV_ODID_UA_TYPE_OTHER for non-aircraft)
# - Or use RID_UA_TYPE = 0 (MAV_ODID_UA_TYPE_NONE for ground station/beacon)

# Board ID for firmware checking
APJ_BOARD_ID 1208

# USB Console Configuration  
# Use USB-Serial/JTAG for SERIAL0 instead of UART0 to avoid dropped messages
# This prevents UART0 buffer overflows when no external UART is connected
define HAL_ESP32_USE_USB_CONSOLE 1
